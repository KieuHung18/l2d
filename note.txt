using System;
using System.IO;
using Spine;
using SkiaSharp;

class Program
{
    static void Main(string[] args)
    {
        string folder = AppDomain.CurrentDomain.BaseDirectory;
        string atlasPath = Path.Combine(folder, "yourFile.atlas");
        string skelPath = Path.Combine(folder, "yourFile.skel");
        string outputJson = Path.Combine(folder, "yourFile_converted.json");

        try
        {
            var atlas = new Atlas(atlasPath, new SkiaTextureLoader(folder));
            var loader = new AtlasAttachmentLoader(atlas);
            var binary = new SkeletonBinary(loader);
            var skeletonData = binary.ReadSkeletonData(skelPath);

            // Convert to JSON
            var json = new SkeletonJson(loader);
            string jsonText = json.WriteSkeletonData(skeletonData);

            File.WriteAllText(outputJson, jsonText);
            Console.WriteLine("✅ Converted to JSON successfully!");
            Console.WriteLine($"Saved to: {outputJson}");
        }
        catch (Exception ex)
        {
            Console.WriteLine("❌ Error: " + ex.Message);
        }
    }
}

// Include this in the same file or a new file (SkiaTextureLoader.cs)
public class SkiaTextureLoader : TextureLoader
{
    private readonly string folder;

    public SkiaTextureLoader(string folderPath)
    {
        folder = folderPath;
    }

    public void Load(AtlasPage page, string path)
    {
        if (!path.EndsWith(".png", StringComparison.OrdinalIgnoreCase))
            path += ".png";

        string filePath = Path.Combine(folder, path);
        if (!File.Exists(filePath))
            throw new FileNotFoundException("Texture not found", filePath);

        using var data = SKData.Create(filePath);
        var img = SKImage.FromEncodedData(data);

        page.rendererObject = img;
        page.width = img.Width;
        page.height = img.Height;
    }

    public void Unload(object texture)
    {
        if (texture is SKImage img)
            img.Dispose();
    }
}